# Phanon Dimensional Mirror
dimensional_mirror_0 = {
	entity = "acot_pmc_portal_disabled_entity"
	construction_entity = "acot_pmc_portal_disabled_entity"
	portrait = "GFX_megastructure_construction_background"
	place_entity_on_planet_plane = no
	build_outside_gravity_well = yes    # indicates this will use "free" placement between the system's inner and outer ring
	# if this option is active, the placement_rules will be completely ignored
	show_galactic_map_icon = yes
	build_time = 1800
	resources = {
		category = megastructures
		cost = {
			alloys = 40000
			acot_sr_dark_energy = 10000
			sr_dark_matter = 10000
			influence = 300
		}
	}
	construction_blocks_and_blocked_by = self_type
	potential = {
		has_technology = tech_phanon_dimensional_mirror
		NOR = {
			has_global_flag = aot_phanon_content_OFF
			has_megastructure = dimensional_mirror_0
			has_megastructure = dimensional_mirror_final
			has_country_flag = completed_dimensional_mirror
		}
	}
	possible = {
		exists = starbase
		custom_tooltip = {
			fail_text = "requires_inside_border"
			is_inside_border = from
		}
		custom_tooltip = {
			fail_text = "requires_surveyed_system"
			NOT = {
				any_system_planet = {
					is_surveyed = {
						who = prev.from
						status = no
					}
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_existing_gateway"
			NOT = {
				has_megastructure = dimensional_mirror_0
			}
		}
	}
	placement_rules = {
		# those would be ignored since the gateway is being "free-placed" between the inner and outer radius of the system
	}
	# root = system
	# from = country
	ai_weight = {
		factor = 5
		modifier = {
			factor = 0
			starbase = {
				NOT = {
					has_starbase_size >= starbase_starfortress
				}
			}
		}
		# ------------------------ We need a decent fleet to fight the Phanon bois ----------------------- #
		modifier = {
			factor = 0
			owner = {
				fleet_power < 1000000
			}
		}
		# -------------------------------- We should have a decent economy ------------------------------- #
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value >= 2000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = acot_sr_dark_energy
					value >= 1000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = sr_dark_matter
					value >= 1000
				}
			}
		}
	}
	on_build_start = {
	}
	on_build_cancel = {
	}
	on_build_complete = {
		from = {
			country_event = {
				id = aot_phanon_events.3
			}
		}
	}
}

dimensional_mirror_final = {
	entity = "acot_pmc_portal_entity"
	construction_entity = "acot_pmc_portal_entity"
	portrait = "GFX_evt_dimensional_mirror"
	place_entity_on_planet_plane = no
	# build_outside_gravity_well = yes 						# indicates this will use "free" placement between the system's inner and outer ring
	# if this option is active, the placement_rules will be completely ignored
	show_galactic_map_icon = yes
	potential = {
		has_technology = tech_phanon_dimensional_mirror
	}
	possible = {
		custom_tooltip = {
			fail_text = "requires_technology_gateway_construction"
			from = {
				has_technology = tech_phanon_dimensional_mirror
			}
		}
	}
	upgrade_from = {
		dimensional_mirror_0
	}
	build_time = 1800
	resources = {
		category = megastructures
		cost = {
			energy = 200000
			sr_dark_matter = 5000
			acot_sr_dark_energy = 5000
		}
	}
	construction_blocks_and_blocked_by = self_type
	on_build_complete = {
		fromfrom = {
			save_event_target_as = dimensional_mirror_obj
		}
		from = {
			country_event = {
				id = aot_phanon_events.4
			}
		}
	}
}

# Phanon Star Imploder Pylon creator.
star_imploder_0 = {
	entity = "construction_platform_entity"
	construction_entity = "construction_platform_entity"
	portrait = "GFX_megastructure_construction_background"
	place_entity_on_planet_plane = no
	entity_offset = {
		x = -7
		y = -7
	}
	construction_blocks_and_blocked_by = none
	build_time = 1800
	resources = {
		category = megastructures
		cost = {
			alloys = 5000
			influence = 300
		}
		upkeep = {
			energy = 5
		}
	}
	prerequisites = {
		tech_phanon_stellar_converter
	}
	potential = {
		NOT = {
			has_global_flag = aot_phanon_content_OFF
		}
		has_technology = tech_phanon_stellar_converter
	}
	possible = {
		exists = starbase
		custom_tooltip = {
			fail_text = "requires_inside_border"
			is_inside_border = from
		}
		custom_tooltip = {
			fail_text = "requires_surveyed_system"
			NOT = {
				any_system_planet = {
					is_surveyed = {
						who = prev.from
						status = no
					}
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_habitable_planets"
			NOT = {
				any_system_planet = {
					AND = {
						colonizable_planet = yes
					}
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_black_hole_neutron_star_pulsar"
			NOT = {
				is_star_class = sc_black_hole
				is_star_class = sc_neutron_star
				is_star_class = sc_pulsar
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_binary_trinary"
			NOR = {
				is_star_class = sc_binary_1
				is_star_class = sc_binary_2
				is_star_class = sc_binary_3
				is_star_class = sc_binary_4
				is_star_class = sc_binary_5
				is_star_class = sc_binary_6
				is_star_class = sc_binary_7
				is_star_class = sc_binary_8
				is_star_class = sc_binary_9
				is_star_class = sc_binary_10
				is_star_class = sc_trinary_1
				is_star_class = sc_trinary_2
				is_star_class = sc_trinary_3
				is_star_class = sc_trinary_4
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_existing_megastructure"
			has_no_non_gate_megastructure = yes
		}
		custom_tooltip = {
			fail_text = "requires_no_phanon_pylon"
			NOT = {
				is_star_class = sc_phanon_pylon
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_star_imploder"
			NOT = {
				has_star_flag = star_imploder_built
			}
		}
	}
	placement_rules = {
		planet_possible = {
			custom_tooltip = {
				fail_text = "requires_no_sigma_star"
				is_star = yes
				NOT = {
					is_star_class = sc_sigma_star
				}
			}
			custom_tooltip = {
				fail_text = "requires_no_anomaly"
				NOT = {
					has_anomaly = yes
				}
			}
		}
	}
	# root = system
	# from = country
	ai_weight = {
		factor = 15
		modifier = {
			factor = 0.1
			starbase = {
				NOT = {
					has_starbase_size >= starbase_starfortress
				}
			}
		}
		# ----------------------------- We need a decent eco to support this ----------------------------- #
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 6000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = sr_dark_matter
					value < 1000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = acot_sr_dark_energy
					value < 1000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 1000
				}
			}
		}
	}
	on_build_start = {
	}
	on_build_cancel = {
	}
	on_build_complete = {
		set_star_flag = star_imploder_built
		from = {
			set_country_flag = built_star_imploder
		}
		every_system_planet = {
			limit = {
				has_modifier = terraforming_candidate
			}
			remove_modifier = terraforming_candidate
		}
		fromfrom.planet = {
			if = {
				limit = {
					has_orbital_station = yes
				}
				orbital_station = {
					dismantle = yes
				}
			}
		}
	}
}

star_imploder_1 = {
	entity = "star_imploder_stage_1_entity"
	construction_entity = "star_imploder_stage_1_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 40000
			sr_dark_matter = 10000
			acot_sr_dark_energy = 10000
		}
		upkeep = {
			energy = 2000
		}
	}
	upgrade_from = {
		star_imploder_0
	}
	prerequisites = {
		tech_phanon_stellar_converter
	}
	ai_weight = {
		factor = 15
		# ----------------------------- We need a decent eco to support this ----------------------------- #
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 6000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = sr_dark_matter
					value < 1000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = acot_sr_dark_energy
					value < 1000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 1000
				}
			}
		}
	}
	on_build_complete = {
		every_system_planet = {
			limit = {
				has_modifier = terraforming_candidate
			}
			remove_modifier = terraforming_candidate
		}
	}
}

star_imploder_2 = {
	entity = "star_imploder_stage_2_entity"
	construction_entity = "star_imploder_stage_2_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 40000
			sr_dark_matter = 10000
			acot_sr_dark_energy = 10000
		}
		upkeep = {
			energy = 4000
		}
	}
	upgrade_from = {
		star_imploder_1
	}
	prerequisites = {
		tech_phanon_stellar_converter
	}
	ai_weight = {
		factor = 15
		# ----------------------------- We need a decent eco to support this ----------------------------- #
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 6000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = sr_dark_matter
					value < 1000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = acot_sr_dark_energy
					value < 1000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 1000
				}
			}
		}
	}
	on_build_complete = {
		every_system_planet = {
			limit = {
				has_modifier = terraforming_candidate
			}
			remove_modifier = terraforming_candidate
		}
	}
}

star_imploder_3 = {
	entity = "star_imploder_stage_3_entity"
	construction_entity = "star_imploder_stage_3_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 40000
			sr_dark_matter = 10000
			acot_sr_dark_energy = 10000
		}
		upkeep = {
			energy = 6000
		}
		produces = {
			aot_sr_runic_power = 1000
		}
	}
	upgrade_from = {
		star_imploder_2
	}
	prerequisites = {
		tech_phanon_stellar_converter
	}
	ai_weight = {
		factor = 15
		# ----------------------------- We need a decent eco to support this ----------------------------- #
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 6000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = sr_dark_matter
					value < 1000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = acot_sr_dark_energy
					value < 1000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 1000
				}
			}
		}
	}
	on_build_complete = {
		from = {
			set_country_flag = has_built_or_repaired_megastructure
		}
		phanon_destroy_solar_system = yes
	}
}

star_imploder_4 = {
	entity = "star_imploder_stage_3_entity"
	construction_entity = "star_imploder_stage_3_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 40000
			aot_sr_runic_power = 20000
		}
		upkeep = {
			energy = 6000
		}
		produces = {
			acot_sr_stellarite = 1000
		}
	}
	ai_weight = {
		factor = 15
		# ----------------------------- We need a decent eco to support this ----------------------------- #
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 6000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 4000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 1000
				}
			}
		}
	}
	upgrade_from = {
		star_imploder_3
	}
	prerequisites = {
		tech_sigma_stellar_converter
	}
	on_build_complete = {
		from = {
			set_country_flag = has_built_or_repaired_megastructure
		}
		create_sigma_Star = yes
	}
}

# Phanon Star Imploder Pylon creator.
sigma_star_imploder_0 = {
	entity = "construction_platform_entity"
	construction_entity = "construction_platform_entity"
	portrait = "GFX_megastructure_construction_background"
	place_entity_on_planet_plane = no
	entity_offset = {
		x = -7
		y = -7
	}
	construction_blocks_and_blocked_by = none
	build_time = 1800
	resources = {
		category = megastructures
		cost = {
			alloys = 5000
			influence = 300
		}
		upkeep = {
			energy = 5
		}
	}
	prerequisites = {
		tech_sigma_stellar_converter
	}
	potential = {
		has_technology = tech_sigma_stellar_converter
	}
	possible = {
		exists = starbase
		custom_tooltip = {
			fail_text = "requires_inside_border"
			is_inside_border = from
		}
		custom_tooltip = {
			fail_text = "requires_surveyed_system"
			NOT = {
				any_system_planet = {
					is_surveyed = {
						who = prev.from
						status = no
					}
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_habitable_planets"
			NOT = {
				any_system_planet = {
					AND = {
						colonizable_planet = yes
					}
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_black_hole_neutron_star_pulsar"
			NOT = {
				is_star_class = sc_black_hole
				is_star_class = sc_neutron_star
				is_star_class = sc_pulsar
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_binary_trinary"
			NOR = {
				is_star_class = sc_binary_1
				is_star_class = sc_binary_2
				is_star_class = sc_binary_3
				is_star_class = sc_binary_4
				is_star_class = sc_binary_5
				is_star_class = sc_binary_6
				is_star_class = sc_binary_7
				is_star_class = sc_binary_8
				is_star_class = sc_binary_9
				is_star_class = sc_binary_10
				is_star_class = sc_trinary_1
				is_star_class = sc_trinary_2
				is_star_class = sc_trinary_3
				is_star_class = sc_trinary_4
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_existing_megastructure"
			has_no_non_gate_megastructure = yes
		}
		custom_tooltip = {
			fail_text = "requires_no_phanon_pylon"
			NOT = {
				is_star_class = sc_phanon_pylon
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_sigma_star_imploder"
			NOT = {
				has_star_flag = sigma_star_imploder_built
			}
		}
	}
	placement_rules = {
		planet_possible = {
			custom_tooltip = {
				fail_text = "must_build_around_star"
				is_star = yes
				NOT = {
					is_star_class = sc_sigma_star
				}
			}
			custom_tooltip = {
				fail_text = "requires_no_anomaly"
				NOT = {
					has_anomaly = yes
				}
			}
		}
	}
	# root = system
	# from = country
	ai_weight = {
		factor = 15
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 4000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 6000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = acot_sr_stellarite
					value < 1000
				}
			}
		}
	}
	on_build_start = {
	}
	on_build_cancel = {
	}
	on_build_complete = {
		set_star_flag = sigma_star_imploder_built
		from = {
			set_country_flag = built_sigma_star_imploder
		}
		every_system_planet = {
			limit = {
				has_modifier = terraforming_candidate
			}
			remove_modifier = terraforming_candidate
		}
		fromfrom.planet = {
			if = {
				limit = {
					has_orbital_station = yes
				}
				orbital_station = {
					dismantle = yes
				}
			}
		}
	}
}

sigma_star_imploder_1 = {
	entity = "star_imploder_stage_1_entity"
	construction_entity = "star_imploder_stage_1_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 40000
			aot_sr_runic_power = 20000
		}
		upkeep = {
			energy = 2000
		}
	}
	upgrade_from = {
		sigma_star_imploder_0
	}
	prerequisites = {
		tech_sigma_stellar_converter
	}
	ai_weight = {
		factor = 15
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 4000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 6000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = acot_sr_stellarite
					value < 1000
				}
			}
		}
	}
	on_build_complete = {
		every_system_planet = {
			limit = {
				has_modifier = terraforming_candidate
			}
			remove_modifier = terraforming_candidate
		}
	}
}

sigma_star_imploder_2 = {
	entity = "star_imploder_stage_2_entity"
	construction_entity = "star_imploder_stage_2_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 40000
			aot_sr_runic_power = 20000
		}
		upkeep = {
			energy = 4000
		}
	}
	upgrade_from = {
		sigma_star_imploder_1
	}
	prerequisites = {
		tech_sigma_stellar_converter
	}
	ai_weight = {
		factor = 15
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 4000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 6000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = acot_sr_stellarite
					value < 1000
				}
			}
		}
	}
	on_build_complete = {
		every_system_planet = {
			limit = {
				has_modifier = terraforming_candidate
			}
			remove_modifier = terraforming_candidate
		}
	}
}

sigma_star_imploder_3 = {
	entity = "star_imploder_stage_3_entity"
	construction_entity = "star_imploder_stage_3_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 40000
			aot_sr_runic_power = 20000
		}
		upkeep = {
			energy = 6000
		}
		produces = {
			acot_sr_stellarite = 1000
		}
	}
	upgrade_from = {
		sigma_star_imploder_2
	}
	prerequisites = {
		tech_sigma_stellar_converter
	}
	on_build_complete = {
		from = {
			set_country_flag = has_built_or_repaired_megastructure
		}
		sigma_destroy_solar_system = yes
	}
	ai_weight = {
		factor = 15
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 4000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 6000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = acot_sr_stellarite
					value < 1000
				}
			}
		}
	}
}

#Phanon MacR.I.P.P.
solaripp_0 = {
	entity = "construction_platform_entity"
	construction_entity = "construction_platform_entity"
	portrait = "GFX_megastructure_construction_background"
	place_entity_on_planet_plane = no
	construction_blocks_and_blocked_by = none
	entity_offset = {
		x = -14
		y = -14
	}
	build_time = 1800
	resources = {
		category = megastructures
		cost = {
			alloys = 5000
			influence = 300
		}
		upkeep = {
			energy = 5
		}
	}
	prerequisites = {
		tech_sigma_solaripp
	}
	potential = {
		has_technology = tech_phanon_stellar_converter
	}
	possible = {
		exists = starbase
		custom_tooltip = {
			fail_text = "requires_inside_border"
			is_inside_border = from
		}
		custom_tooltip = {
			fail_text = "requires_surveyed_system"
			NOT = {
				any_system_planet = {
					is_surveyed = {
						who = prev.from
						status = no
					}
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_sigma_star"
			any_system_planet = {
				is_star_class = sc_sigma_star
				colonizable_planet = no
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_solaripp"
			NOT = {
				has_star_flag = system_has_solaripp
			}
		}
	}
	placement_rules = {
		planet_possible = {
			custom_tooltip = {
				fail_text = "must_built_around_sigma_star"
				is_star_class = sc_sigma_star
				colonizable_planet = no
			}
			custom_tooltip = {
				fail_text = "requires_no_anomaly"
				NOT = {
					has_anomaly = yes
				}
			}
		}
	}
	# root = system
	# from = country
	ai_weight = {
		factor = 15
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 4000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 4000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = acot_sr_stellarite
					value < 1000
				}
			}
		}
	}
	on_build_start = {
	}
	on_build_cancel = {
	}
	on_build_complete = {
		set_star_flag = system_has_solaripp
		from = {
			set_country_flag = built_solaripp
		}
		every_system_planet = {
			limit = {
				has_modifier = terraforming_candidate
			}
			remove_modifier = terraforming_candidate
		}
		fromfrom.planet = {
			if = {
				limit = {
					has_orbital_station = yes
				}
				orbital_station = {
					dismantle = yes
				}
			}
		}
	}
}

solaripp_1 = {
	entity = "sigma_solaRIPP_stage_1_entity"
	construction_entity = "sigma_solaRIPP_stage_1_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 80000
			aot_sr_runic_power = 10000
		}
		upkeep = {
			energy = 2000
		}
	}
	upgrade_from = {
		solaripp_0
	}
	prerequisites = {
		tech_sigma_solaripp
	}
	ai_weight = {
		factor = 15
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 4000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 4000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = acot_sr_stellarite
					value < 1000
				}
			}
		}
	}
	on_build_complete = {
	}
}

solaripp_2 = {
	entity = "sigma_solaRIPP_stage_2_entity"
	construction_entity = "sigma_solaRIPP_stage_2_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 80000
			aot_sr_runic_power = 10000
		}
		upkeep = {
			energy = 4000
		}
	}
	upgrade_from = {
		solaripp_1
	}
	prerequisites = {
		tech_sigma_solaripp
	}
	ai_weight = {
		factor = 15
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 4000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 4000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = acot_sr_stellarite
					value < 1000
				}
			}
		}
	}
	on_build_complete = {
	}
}

solaripp_3 = {
	entity = "sigma_solaRIPP_stage_2_entity"
	construction_entity = "sigma_solaRIPP_stage_2_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 80000
			aot_sr_runic_power = 10000
		}
	}
	upgrade_from = {
		solaripp_2
	}
	prerequisites = {
		tech_sigma_solaripp
	}
	on_build_complete = {
		from = {
			set_country_flag = has_built_or_repaired_megastructure
		}
		spawn_planet = {
			class = pc_sigma_solaripp
			location = fromfrom
			has_ring = no
			init_effect = {
				set_name = "STARLIGHT"
				change_pc = pc_sigma_solaripp
				set_colony_type = col_sigma_solaripp
				add_modifier = {
					modifier = sigma_solaripp_mod
					days = -1
				}
				set_planet_entity = {
					entity = "sigma_solaRIPP_stage_3_entity"
				}
				set_surveyed = {
					surveyed = yes
					surveyor = FROM
				}
				set_all_comms_surveyed = yes
				clear_blockers = yes
				set_planet_flag = megastructure
				set_planet_flag = macRIPP_planet
			}
		}
		remove_megastructure = fromfrom
	}
	ai_weight = {
		factor = 15
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 4000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 4000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = acot_sr_stellarite
					value < 1000
				}
			}
		}
	}
}

# Phanon Great WAll.
phanon_great_wall_0 = {
	entity = "construction_platform_entity"
	construction_entity = "construction_platform_entity"
	portrait = "GFX_megastructure_construction_background"
	place_entity_on_planet_plane = no
	construction_blocks_and_blocked_by = none
	entity_offset = {
		x = -14
		y = -14
	}
	build_time = 1800
	resources = {
		category = megastructures
		cost = {
			alloys = 5000
			influence = 300
		}
		upkeep = {
			energy = 5
		}
	}
	prerequisites = {
		tech_phanon_great_wall
	}
	potential = {
		NOT = {
			has_global_flag = aot_phanon_content_OFF
		}
		has_technology = tech_phanon_great_wall
	}
	possible = {
		exists = starbase
		custom_tooltip = {
			fail_text = "requires_inside_border"
			is_inside_border = from
		}
		custom_tooltip = {
			fail_text = "requires_surveyed_system"
			NOT = {
				any_system_planet = {
					is_surveyed = {
						who = prev.from
						status = no
					}
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_phanon_macripp"
			any_system_planet = {
				OR = {
					is_star_class = sc_phanon_pylon
					is_star_class = sc_sigma_star
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_great_wall"
			NOT = {
				has_star_flag = great_wall_built
			}
		}
	}
	placement_rules = {
		planet_possible = {
			custom_tooltip = {
				fail_text = "must_built_around_phanon_macripp"
				OR = {
					is_star_class = sc_phanon_pylon
					is_star_class = sc_sigma_star
				}
			}
			custom_tooltip = {
				fail_text = "requires_no_anomaly"
				NOT = {
					has_anomaly = yes
				}
			}
		}
	}
	# root = system
	# from = country
	ai_weight = {
		factor = 15
		modifier = {
			factor = 3
			any_neighbor_system = {
				owner = {
					is_rival = from
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 5000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 2500
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 8000
				}
			}
		}
	}
	on_build_start = {
	}
	on_build_cancel = {
	}
	on_build_complete = {
		set_star_flag = great_wall_built
		from = {
			set_country_flag = built_great_wall
		}
	}
}

phanon_great_wall_1 = {
	entity = "phanon_great_wall_stage_1_entity"
	construction_entity = "phanon_great_wall_stage_1_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 200000
			aot_sr_runic_power = 10000
		}
		upkeep = {
			energy = 2000
		}
	}
	upgrade_from = {
		phanon_great_wall_0
	}
	prerequisites = {
		tech_phanon_great_wall
	}
	ai_weight = {
		factor = 15
		modifier = {
			factor = 3
			any_neighbor_system = {
				owner = {
					is_rival = from
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 5000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 2500
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 8000
				}
			}
		}
	}
	on_build_complete = {
		spawn_inner_phanon_mega_turrets = yes
	}
}

phanon_great_wall_2 = {
	entity = "phanon_great_wall_stage_2_entity"
	construction_entity = "phanon_great_wall_stage_2_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 300000
			aot_sr_runic_power = 10000
		}
		upkeep = {
			energy = 4000
		}
	}
	upgrade_from = {
		phanon_great_wall_1
	}
	prerequisites = {
		tech_phanon_great_wall
	}
	ai_weight = {
		factor = 15
		modifier = {
			factor = 3
			any_neighbor_system = {
				owner = {
					is_rival = from
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 5000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 2500
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 8000
				}
			}
		}
	}
	on_build_complete = {
		spawn_great_wall_macripps = yes
	}
}

phanon_great_wall_3 = {
	entity = "phanon_great_wall_stage_3_entity"
	construction_entity = "phanon_great_wall_stage_3_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 200000
			aot_sr_runic_power = 10000
		}
		upkeep = {
			energy = 6000
		}
		produces = {
			aot_sr_runic_power = 100
		}
	}
	upgrade_from = {
		phanon_great_wall_2
	}
	prerequisites = {
		tech_phanon_great_wall
	}
	on_build_complete = {
	}
	ai_weight = {
		factor = 15
		modifier = {
			factor = 3
			any_neighbor_system = {
				owner = {
					is_rival = from
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 5000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 2500
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 8000
				}
			}
		}
	}
}

phanon_great_wall_4 = {
	entity = "phanon_great_wall_stage_4_entity"
	construction_entity = "phanon_great_wall_stage_4_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 200000
			aot_sr_runic_power = 10000
		}
		upkeep = {
			energy = 8000
		}
		produces = {
			aot_sr_runic_power = 100
		}
	}
	upgrade_from = {
		phanon_great_wall_3
	}
	prerequisites = {
		tech_phanon_great_wall
	}
	ai_weight = {
		factor = 15
		modifier = {
			factor = 3
			any_neighbor_system = {
				owner = {
					is_rival = from
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 5000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 2500
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 8000
				}
			}
		}
	}
	on_build_complete = {
		from = {
			set_country_flag = has_built_or_repaired_megastructure
		}
		spawn_outer_phanon_mega_turrets = yes
	}
}

phanon_megaturret_intermediate_1 = {
	entity = "aot_megaturret_frame_entity"
	construction_entity = ""
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	show_in_outliner = no
	resources = {
		category = megastructures
		cost = {
			alloys = 40000
			aot_sr_runic_power = 1000
		}
		upkeep = {
			energy = 0
		}
		produces = {
		}
	}
	upgrade_desc = hide
	potential = {
		always = no
	}
	on_build_complete = {
		from = {
			set_country_flag = has_built_or_repaired_megastructure
		}
	}
}

phanon_megaturret_1 = {
	entity = "phanon_great_wall_megaturret_stage_1_entity"
	construction_entity = "phanon_great_wall_megaturret_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	show_in_outliner = no
	resources = {
		category = megastructures
		cost = {
			alloys = 40000
			aot_sr_runic_power = 1000
		}
		upkeep = {
			energy = 500
		}
		produces = {
		}
	}
	# ------------------------------------ Can afford the upkeep? ------------------------------------ #
	ai_weight = {
		factor = 30
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 500
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2500
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				resource_stockpile_compare = {
					resource = aot_sr_runic_power
					value < 250
				}
			}
		}
	}
	potential = {
		NOT = {
			has_global_flag = aot_phanon_content_OFF
		}
		has_technology = tech_phanon_great_wall
	}
	upgrade_from = {
		phanon_megaturret_intermediate_1
	}
	prerequisites = {
		tech_phanon_great_wall
	}
	on_build_complete = {
	}
}

phanon_megaturret_2 = {
	entity = "phanon_great_wall_megaturret_stage_1_entity"
	construction_entity = "phanon_great_wall_megaturret_stage_2_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	show_in_outliner = no
	resources = {
		category = megastructures
		cost = {
			alloys = 40000
			aot_sr_runic_power = 1000
		}
		upkeep = {
			energy = 500
		}
		produces = {
		}
	}
	# ------------------------------------ Can afford the upkeep? ------------------------------------ #
	ai_weight = {
		factor = 30
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = energy
					value < 500
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2500
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				resource_stockpile_compare = {
					resource = aot_sr_runic_power
					value < 250
				}
			}
		}
	}
	upgrade_from = {
		phanon_megaturret_1
	}
	prerequisites = {
		tech_phanon_great_wall
	}
	on_build_complete = {
		spawn_functional_megaturret = yes
	}
}

phanon_megaturret_destroyed_0 = {
	entity = "destroyed_aot_megaturret_entity"
	construction_entity = "phanon_great_wall_megaturret_stage_2_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
		}
		upkeep = {
		}
		produces = {
		}
	}
	# Can't build this ever.
	potential = {
		always = no
	}
	upgrade_from = {
	}
	prerequisites = {
		tech_phanon_great_wall
	}
	on_build_complete = {
	}
}

phanon_megaturret_destroyed_1 = {
	entity = "phanon_great_wall_megaturret_stage_1_entity"
	construction_entity = "phanon_great_wall_megaturret_stage_2_construction_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 40000
			aot_sr_runic_power = 1000
		}
		upkeep = {
		}
		produces = {
		}
	}
	# ------------------- Can we afford the repair? If yes give it a higher weight ------------------- #
	ai_weight = {
		factor = 60
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2500
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				resource_stockpile_compare = {
					resource = aot_sr_runic_power
					value < 250
				}
			}
		}
	}
	potential = {
		NOT = {
			has_global_flag = aot_phanon_content_OFF
		}
		has_technology = tech_phanon_great_wall
	}
	upgrade_from = {
		phanon_megaturret_destroyed_0
	}
	prerequisites = {
		tech_phanon_great_wall
	}
	on_build_complete = {
		remove_megastructure = fromfrom
		spawn_functional_megaturret = yes
	}
}

aot_macripp_dark_matter_obelisk_core_pe = {
	entity = "aot_precursor_dark_obelisk_pe_entity"
	construction_entity = "aot_precursor_dark_obelisk_pe_entity"
	portrait = "GFX_acot_dark_obelisk_background"
	place_entity_on_planet_plane = yes
	show_in_outliner = no
	entity_offset = {
		x = 0
		y = 0
	}
	# used from script only
	#upgrade_desc = hide
	potential = {
		always = no
	}
	country_modifier = {
	}
	prerequisites = {
		tech_precursor_enigmalith_pe
	}
	upgrade_from = {
	}
	build_time = 1400
	resources = {
		category = megastructures
		cost = {
			alloys = 10000
			sr_dark_matter = 20000
			acot_sr_dark_energy = 20000
			aot_sr_runic_power = 5000
		}
		upkeep = {
		}
		produces = {
			energy = 2000
			alloys = 2000
			sr_dark_matter = 2500
			acot_sr_dark_energy = 2500
			aot_sr_runic_power = 500
		}
	}
}

# Special version of the obelisk to reside on the planet plane
aot_macripp_dark_matter_obelisk_core_se = {
	entity = "precursor_dark_obelisk_se_entity"
	construction_entity = "precursor_dark_obelisk_se_entity"
	portrait = "GFX_acot_dark_obelisk_se_background"
	show_in_outliner = no
	prerequisites = {
		"tech_precursor_enigmalith_se"
	}
	upgrade_from = {
		aot_macripp_dark_matter_obelisk_core_pe
	}
	place_entity_on_planet_plane = yes
	entity_offset = {
		x = 0
		y = 0
	}
	# used from script only
	#upgrade_desc = hide
	potential = {
	}
	construction_blocks_and_blocked_by = none
	country_modifier = {
	}
	build_time = 1800
	resources = {
		category = megastructures
		cost = {
			alloys = 10000
			aot_sr_runic_power = 20000
			acot_sr_stellarite = 10000
		}
		upkeep = {
		}
		produces = {
			energy = 2500
			alloys = 2500
			sr_dark_matter = 2500
			acot_sr_dark_energy = 2500
			aot_sr_runic_power = 2000
			acot_sr_stellarite = 500
		}
	}
	# ----------- Encourage building this if we can afford it but have low monthly incomes ----------- #
	ai_weight = {
		factor = 5
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = energy
					value < 2500
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 2500
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = sr_dark_matter
					value < 2500
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = acot_sr_dark_energy
					value < 2500
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 2000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = acot_sr_stellarite
					value < 500
				}
			}
		}
	}
}

aot_macripp_dark_matter_obelisk_core_oe = {
	entity = "precursor_dark_obelisk_oe_entity"
	construction_entity = "precursor_dark_obelisk_oe_entity"
	portrait = "GFX_acot_dark_obelisk_oe_background"
	show_in_outliner = no
	prerequisites = {
		tech_precursor_enigmalith_oe
	}
	place_entity_on_planet_plane = yes
	entity_offset = {
		x = 0
		y = 0
	}
	upgrade_from = {
		aot_macripp_dark_matter_obelisk_core_se
	}
	# used from script only
	#upgrade_desc = hide
	potential = {
	}
	construction_blocks_and_blocked_by = none
	build_time = 700
	resources = {
		category = megastructures
		cost = {
			acot_sr_light_matter = 2500
		}
		upkeep = {
		}
		produces = {
			energy = 5000
			alloys = 5000
			acot_sr_stellarite = 10000
			aot_sr_runic_power = 10000
		}
	}
	# ----------- Encourage building this if we can afford it but have low monthly incomes ----------- #
	ai_weight = {
		factor = 20
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = energy
					value < 5000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = alloys
					value < 5000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = aot_sr_runic_power
					value < 10000
				}
			}
		}
		modifier = {
			factor = 2
			owner = {
				has_monthly_income = {
					resource = acot_sr_stellarite
					value < 10000
				}
			}
		}
	}
}

# Make new Habitats directly buildable
dm_habitat_0 = {
	entity = "dm_habitat_phase_03_entity"
	construction_entity = "dm_habitat_phase_03_entity"
	portrait = "GFX_megastructure_habitat_background"
	place_entity_on_planet_plane = no
	show_galactic_map_icon = no
	hide_name = yes
	show_in_outliner = no
	construction_blocks_and_blocked_by = self_type
	entity_offset = {
		x = 7
		y = -7
	}
	build_time = 1800
	resources = {
		category = megastructures_habitat
		cost = {
			influence = 150
			alloys = 3000
			sr_dark_matter = 5000
		}
	}
	potential = {
		has_technology = tech_dm_habitat
	}
	prerequisites = {
		tech_dm_habitat
	}
	possible = {
		exists = starbase
		custom_tooltip = {
			fail_text = "requires_inside_border"
			is_inside_border = from
		}
		custom_tooltip = {
			fail_text = "requires_not_habitat_central_complex"
			NOT = {
				OR = {
					any_system_planet = {
						has_planet_flag = habitat
					}
					has_megastructure = habitat_central_complex_ruined
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_orbital_debris"
			NOT = {
				any_system_planet = {
					has_planet_flag = has_orbital_debris
				}
			}
		}
	}
	placement_rules = {
		planet_possible = {
			custom_tooltip = {
				fail_text = "requires_surveyed_planet"
				is_surveyed = {
					# prevent leaking habitability information
					who = prev.from
					status = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_no_anomaly"
				NOT = {
					has_anomaly = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_no_existing_megastructure"
				#can_build_megastructure_on_planet = yes
				NOR = {
					has_planet_flag = megastructure
					has_planet_flag = has_megastructure
					solar_system = {
						OR = {
							has_star_flag = ring_world_built
							has_star_flag = ithomes_gate
						}
					}
					is_planet_class = pc_ringworld_habitable
					is_planet_class = pc_ringworld_habitable_damaged
					is_planet_class = pc_ringworld_tech
					is_planet_class = pc_ringworld_tech_damaged
					is_planet_class = pc_ringworld_seam
					is_planet_class = pc_ringworld_seam_damaged
					is_planet_class = pc_habitat
					is_aot_habitat = yes
				}
			}
			# balance for habitats
			custom_tooltip = {
				fail_text = "requires_not_minor_planetary_body"
				NOR = {
					is_asteroid = yes
					is_moon = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_not_solarpunk"
				NOT = {
					solar_system = {
						has_star_flag = solarpunk_system_02
					}
				}
			}
			if = {
				limit = {
					from = {
						is_ai = yes
					}
				}
				or = {
					has_deposit_for = shipclass_mining_station
					has_deposit_for = shipclass_research_station
				}
			}
		}
		# use these for all non-star megastructures
	}
	# root = system
	# from = country
	ai_weight = {
		factor = 5
		modifier = {
			factor = 5
			exists = sector
			sector = {
				has_sector_type = core_sector
			}
		}
		modifier = {
			factor = 100
			OR = {
				has_star_flag = ideal_habitat_t1
				has_star_flag = ideal_habitat_t2
			}
		}
		modifier = {
			factor = value:num_orbital_sites
		}
	}
	on_build_complete = {
		fromfrom.planet = {
			save_event_target_as = target_planet
		}
		spawn_planet = {
			class = pc_dm_habitat
			location = fromfrom.planet
			orbit_angle_offset = 135
			orbit_distance_offset = 9.899
			orbit_location = yes
			init_effect = {
				create_dm_habitat = yes
				set_name = {
					key = HABITAT_PLANET_NAME
					variable_string = "[FROM.from.solar_system.GetName]"
				}
				set_planet_entity = {
					entity = "dm_habitat_phase_03_entity"
				}
				set_surveyed = {
					surveyed = yes
					surveyor = FROM
				}
				save_event_target_as = target_habitat
				add_aot_habitat_deposits = yes
				event_target:target_planet = {
					set_planet_flag = habitat@PREV
				}
			}
		}
		fromfrom.solar_system = {
			set_star_flag = has_dm_habitat
		}
		if = {
			limit = {
				event_target:target_planet = {
					OR = {
						has_deposit_for = shipclass_research_station
						has_deposit_for = shipclass_mining_station
					}
				}
			}
			on_orbital_complete_effect = {
				BODY = dm_major
				TYPE = resource
			}
		}
		else = {
			on_orbital_complete_effect = {
				BODY = dm_major
				TYPE = generic
			}
		}
		remove_megastructure = fromfrom
		from = {
			country_event = {
				id = megastructures.10
			}
		}
	}
}

ae_habitat_0 = {
	entity = "alpha_habitat_phase_03_entity"
	construction_entity = "alpha_habitat_phase_03_entity"
	portrait = "GFX_megastructure_habitat_background"
	place_entity_on_planet_plane = no
	show_galactic_map_icon = no
	hide_name = yes
	show_in_outliner = no
	construction_blocks_and_blocked_by = self_type
	entity_offset = {
		x = 7
		y = -7
	}
	build_time = 1800
	resources = {
		category = megastructures_habitat
		cost = {
			influence = 150
			alloys = 3000
			sr_dark_matter = 5000
		}
	}
	potential = {
		has_technology = tech_ae_habitat
	}
	prerequisites = {
		tech_ae_habitat
	}
	possible = {
		exists = starbase
		custom_tooltip = {
			fail_text = "requires_inside_border"
			is_inside_border = from
		}
		custom_tooltip = {
			fail_text = "requires_not_habitat_central_complex"
			NOT = {
				OR = {
					any_system_planet = {
						has_planet_flag = habitat
					}
					has_megastructure = habitat_central_complex_ruined
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_orbital_debris"
			NOT = {
				any_system_planet = {
					has_planet_flag = has_orbital_debris
				}
			}
		}
	}
	placement_rules = {
		planet_possible = {
			custom_tooltip = {
				fail_text = "requires_surveyed_planet"
				is_surveyed = {
					# prevent leaking habitability information
					who = prev.from
					status = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_no_anomaly"
				NOT = {
					has_anomaly = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_no_existing_megastructure"
				#can_build_megastructure_on_planet = yes
				NOR = {
					has_planet_flag = megastructure
					has_planet_flag = has_megastructure
					solar_system = {
						OR = {
							has_star_flag = ring_world_built
							has_star_flag = ithomes_gate
						}
					}
					is_planet_class = pc_ringworld_habitable
					is_planet_class = pc_ringworld_habitable_damaged
					is_planet_class = pc_ringworld_tech
					is_planet_class = pc_ringworld_tech_damaged
					is_planet_class = pc_ringworld_seam
					is_planet_class = pc_ringworld_seam_damaged
					is_planet_class = pc_habitat
					is_aot_habitat = yes
				}
			}
			# balance for habitats
			custom_tooltip = {
				fail_text = "requires_not_minor_planetary_body"
				NOR = {
					is_asteroid = yes
					is_moon = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_not_solarpunk"
				NOT = {
					solar_system = {
						has_star_flag = solarpunk_system_02
					}
				}
			}
			if = {
				limit = {
					from = {
						is_ai = yes
					}
				}
				or = {
					has_deposit_for = shipclass_mining_station
					has_deposit_for = shipclass_research_station
				}
			}
		}
		# use these for all non-star megastructures
	}
	# root = system
	# from = country
	ai_weight = {
		factor = 5
		modifier = {
			factor = 5
			exists = sector
			sector = {
				has_sector_type = core_sector
			}
		}
		modifier = {
			factor = 100
			OR = {
				has_star_flag = ideal_habitat_t1
				has_star_flag = ideal_habitat_t2
			}
		}
		modifier = {
			factor = value:num_orbital_sites
		}
	}
	on_build_complete = {
		fromfrom.planet = {
			save_event_target_as = target_planet
		}
		spawn_planet = {
			class = pc_ae_habitat
			location = fromfrom.planet
			orbit_angle_offset = 135
			orbit_distance_offset = 9.899
			orbit_location = yes
			init_effect = {
				create_ae_habitat = yes
				set_name = {
					key = HABITAT_PLANET_NAME
					variable_string = "[FROM.from.solar_system.GetName]"
				}
				set_planet_entity = {
					entity = "alpha_habitat_phase_03_entity"
				}
				set_surveyed = {
					surveyed = yes
					surveyor = FROM
				}
				save_event_target_as = target_habitat
				add_aot_habitat_deposits = yes
				event_target:target_planet = {
					set_planet_flag = habitat@PREV
				}
			}
		}
		fromfrom.solar_system = {
			set_star_flag = has_ae_habitat
		}
		if = {
			limit = {
				event_target:target_planet = {
					OR = {
						has_deposit_for = shipclass_research_station
						has_deposit_for = shipclass_mining_station
					}
				}
			}
			on_orbital_complete_effect = {
				BODY = ae_major
				TYPE = resource
			}
		}
		else = {
			on_orbital_complete_effect = {
				BODY = ae_major
				TYPE = generic
			}
		}
		remove_megastructure = fromfrom
		from = {
			country_event = {
				id = megastructures.10
			}
		}
	}
}

phanon_habitat_0 = {
	entity = "phanon_habitat_phase_03_entity"
	construction_entity = "phanon_habitat_phase_03_entity"
	portrait = "GFX_megastructure_habitat_background"
	place_entity_on_planet_plane = no
	show_galactic_map_icon = no
	hide_name = yes
	show_in_outliner = no
	construction_blocks_and_blocked_by = self_type
	entity_offset = {
		x = 7
		y = -7
	}
	build_time = 1800
	resources = {
		category = megastructures_habitat
		cost = {
			influence = 150
			alloys = 3000
			sr_dark_matter = 5000
		}
	}
	potential = {
		has_technology = tech_phanon_habitat
	}
	prerequisites = {
		tech_phanon_habitat
	}
	possible = {
		exists = starbase
		custom_tooltip = {
			fail_text = "requires_inside_border"
			is_inside_border = from
		}
		custom_tooltip = {
			fail_text = "requires_not_habitat_central_complex"
			NOT = {
				OR = {
					any_system_planet = {
						has_planet_flag = habitat
					}
					has_megastructure = habitat_central_complex_ruined
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_orbital_debris"
			NOT = {
				any_system_planet = {
					has_planet_flag = has_orbital_debris
				}
			}
		}
	}
	placement_rules = {
		planet_possible = {
			custom_tooltip = {
				fail_text = "requires_surveyed_planet"
				is_surveyed = {
					# prevent leaking habitability information
					who = prev.from
					status = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_no_anomaly"
				NOT = {
					has_anomaly = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_no_existing_megastructure"
				#can_build_megastructure_on_planet = yes
				NOR = {
					has_planet_flag = megastructure
					has_planet_flag = has_megastructure
					solar_system = {
						OR = {
							has_star_flag = ring_world_built
							has_star_flag = ithomes_gate
						}
					}
					is_planet_class = pc_ringworld_habitable
					is_planet_class = pc_ringworld_habitable_damaged
					is_planet_class = pc_ringworld_tech
					is_planet_class = pc_ringworld_tech_damaged
					is_planet_class = pc_ringworld_seam
					is_planet_class = pc_ringworld_seam_damaged
					is_planet_class = pc_habitat
					is_aot_habitat = yes
				}
			}
			# balance for habitats
			custom_tooltip = {
				fail_text = "requires_not_minor_planetary_body"
				NOR = {
					is_asteroid = yes
					is_moon = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_not_solarpunk"
				NOT = {
					solar_system = {
						has_star_flag = solarpunk_system_02
					}
				}
			}
			if = {
				limit = {
					from = {
						is_ai = yes
					}
				}
				or = {
					has_deposit_for = shipclass_mining_station
					has_deposit_for = shipclass_research_station
				}
			}
		}
		# use these for all non-star megastructures
	}
	# root = system
	# from = country
	ai_weight = {
		factor = 5
		modifier = {
			factor = 5
			exists = sector
			sector = {
				has_sector_type = core_sector
			}
		}
		modifier = {
			factor = 100
			OR = {
				has_star_flag = ideal_habitat_t1
				has_star_flag = ideal_habitat_t2
			}
		}
		modifier = {
			factor = value:num_orbital_sites
		}
	}
	on_build_complete = {
		fromfrom.planet = {
			save_event_target_as = target_planet
		}
		spawn_planet = {
			class = pc_phanon_habitat
			location = fromfrom.planet
			orbit_angle_offset = 135
			orbit_distance_offset = 9.899
			orbit_location = yes
			init_effect = {
				create_phanon_habitat = yes
				set_name = {
					key = HABITAT_PLANET_NAME
					variable_string = "[FROM.from.solar_system.GetName]"
				}
				set_planet_entity = {
					entity = "phanon_habitat_phase_03_entity"
				}
				set_surveyed = {
					surveyed = yes
					surveyor = FROM
				}
				save_event_target_as = target_habitat
				add_aot_habitat_deposits = yes
				event_target:target_planet = {
					set_planet_flag = habitat@PREV
				}
			}
		}
		fromfrom.solar_system = {
			set_star_flag = has_phanon_habitat
		}
		if = {
			limit = {
				event_target:target_planet = {
					OR = {
						has_deposit_for = shipclass_research_station
						has_deposit_for = shipclass_mining_station
					}
				}
			}
			on_orbital_complete_effect = {
				BODY = phanon_major
				TYPE = resource
			}
		}
		else = {
			on_orbital_complete_effect = {
				BODY = phanon_major
				TYPE = generic
			}
		}
		remove_megastructure = fromfrom
		from = {
			country_event = {
				id = megastructures.10
			}
		}
	}
}

stellarite_habitat_0 = {
	entity = "sigma_habitat_phase_03_entity"
	construction_entity = "sigma_habitat_phase_03_entity"
	portrait = "GFX_megastructure_habitat_background"
	place_entity_on_planet_plane = no
	show_galactic_map_icon = no
	hide_name = yes
	show_in_outliner = no
	construction_blocks_and_blocked_by = self_type
	entity_offset = {
		x = 7
		y = -7
	}
	build_time = 1800
	resources = {
		category = megastructures_habitat
		cost = {
			influence = 150
			alloys = 3000
			sr_dark_matter = 5000
		}
	}
	potential = {
		has_technology = tech_stellarite_habitat
	}
	prerequisites = {
		tech_stellarite_habitat
	}
	possible = {
		exists = starbase
		custom_tooltip = {
			fail_text = "requires_inside_border"
			is_inside_border = from
		}
		custom_tooltip = {
			fail_text = "requires_not_habitat_central_complex"
			NOT = {
				OR = {
					any_system_planet = {
						has_planet_flag = habitat
					}
					has_megastructure = habitat_central_complex_ruined
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_orbital_debris"
			NOT = {
				any_system_planet = {
					has_planet_flag = has_orbital_debris
				}
			}
		}
	}
	placement_rules = {
		planet_possible = {
			custom_tooltip = {
				fail_text = "requires_surveyed_planet"
				is_surveyed = {
					# prevent leaking habitability information
					who = prev.from
					status = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_no_anomaly"
				NOT = {
					has_anomaly = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_no_existing_megastructure"
				#can_build_megastructure_on_planet = yes
				NOR = {
					has_planet_flag = megastructure
					has_planet_flag = has_megastructure
					solar_system = {
						OR = {
							has_star_flag = ring_world_built
							has_star_flag = ithomes_gate
						}
					}
					is_planet_class = pc_ringworld_habitable
					is_planet_class = pc_ringworld_habitable_damaged
					is_planet_class = pc_ringworld_tech
					is_planet_class = pc_ringworld_tech_damaged
					is_planet_class = pc_ringworld_seam
					is_planet_class = pc_ringworld_seam_damaged
					is_planet_class = pc_habitat
					is_aot_habitat = yes
				}
			}
			# balance for habitats
			custom_tooltip = {
				fail_text = "requires_not_minor_planetary_body"
				NOR = {
					is_asteroid = yes
					is_moon = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_not_solarpunk"
				NOT = {
					solar_system = {
						has_star_flag = solarpunk_system_02
					}
				}
			}
			if = {
				limit = {
					from = {
						is_ai = yes
					}
				}
				or = {
					has_deposit_for = shipclass_mining_station
					has_deposit_for = shipclass_research_station
				}
			}
		}
		# use these for all non-star megastructures
	}
	# root = system
	# from = country
	ai_weight = {
		factor = 5
		modifier = {
			factor = 5
			exists = sector
			sector = {
				has_sector_type = core_sector
			}
		}
		modifier = {
			factor = 100
			OR = {
				has_star_flag = ideal_habitat_t1
				has_star_flag = ideal_habitat_t2
			}
		}
		modifier = {
			factor = value:num_orbital_sites
		}
	}
	on_build_complete = {
		fromfrom.planet = {
			save_event_target_as = target_planet
		}
		spawn_planet = {
			class = pc_sigma_habitat
			location = fromfrom.planet
			orbit_angle_offset = 135
			orbit_distance_offset = 9.899
			orbit_location = yes
			init_effect = {
				create_sigma_habitat = yes
				set_name = {
					key = HABITAT_PLANET_NAME
					variable_string = "[FROM.from.solar_system.GetName]"
				}
				set_planet_entity = {
					entity = "sigma_habitat_phase_03_entity"
				}
				set_surveyed = {
					surveyed = yes
					surveyor = FROM
				}
				save_event_target_as = target_habitat
				add_aot_habitat_deposits = yes
				event_target:target_planet = {
					set_planet_flag = habitat@PREV
				}
			}
		}
		fromfrom.solar_system = {
			set_star_flag = has_sigma_habitat
		}
		if = {
			limit = {
				event_target:target_planet = {
					OR = {
						has_deposit_for = shipclass_research_station
						has_deposit_for = shipclass_mining_station
					}
				}
			}
			on_orbital_complete_effect = {
				BODY = sigma_major
				TYPE = resource
			}
		}
		else = {
			on_orbital_complete_effect = {
				BODY = sigma_major
				TYPE = generic
			}
		}
		remove_megastructure = fromfrom
		from = {
			country_event = {
				id = megastructures.10
			}
		}
	}
}

# Enigmatic lock to keep those pesky hordes outside

enigmatic_lock_0 = {
	entity = "construction_platform_entity"
	construction_entity = "construction_platform_entity"
	portrait = "GFX_megastructure_construction_background"
	construction_blocks_and_blocked_by = none
	place_entity_on_planet_plane = no
	build_outside_gravity_well = yes    # indicates this will use "free" placement between the system's inner and outer ring
	# if this option is active, the placement_rules will be completely ignored
	show_galactic_map_icon = yes
	build_time = 1800
	resources = {
		category = megastructures
		cost = {
			alloys = 5000
			influence = 100
		}
	}
	construction_blocks_and_blocked_by = self_type
	potential = {
		has_technology = tech_aot_enigmatic_lock_mega
	}
	prerequisites = {
		tech_aot_enigmatic_lock_mega
	}
	possible = {
		exists = starbase
		custom_tooltip = {
			fail_text = "requires_inside_border"
			is_inside_border = from
		}
		custom_tooltip = {
			fail_text = "requires_surveyed_system"
			NOT = {
				any_system_planet = {
					is_surveyed = {
						who = prev.from
						status = no
					}
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_valid_bypass"
			any_bypass = {
				solar_system = {
					has_owner = yes
					owner = {
						is_same_value = root.owner
					}
				}
				is_valid_bypass_for_lock = yes
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_existing_enigmatic_lock"
			NOR = {
				has_megastructure = enigmatic_lock_0
				has_megastructure = enigmatic_lock_1
			}
		}
	}
	placement_rules = {
		# those would be ignored since the gateway is being "free-placed" between the inner and outer radius of the system
	}
	# root = system
	# from = country
	ai_weight = {
		factor = 5
		modifier = {
			factor = 0
			starbase = {
				NOT = {
					has_starbase_size >= starbase_starfortress
				}
			}
		}
		# -------------------------------- We should have a decent economy ------------------------------- #
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = alloys
					value >= 2000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = acot_sr_dark_energy
					value >= 1000
				}
			}
		}
		modifier = {
			factor = 0
			owner = {
				has_monthly_income = {
					resource = sr_dark_matter
					value >= 1000
				}
			}
		}
	}
	on_build_start = {
	}
	on_build_cancel = {
	}
	on_build_complete = {
		#from = {
		#	country_event = {
		#		id = aot_phanon_events.3
		#	}
		#}
	}
}

enigmatic_lock_1 = {
	entity = "aot_enigmatic_lock_entity"
	construction_entity = "aot_enigmatic_lock_entity"
	portrait = "GFX_megastructure_construction_background"
	construction_blocks_and_blocked_by = none
	place_entity_on_planet_plane = no
	build_outside_gravity_well = yes    # indicates this will use "free" placement between the system's inner and outer ring
	# if this option is active, the placement_rules will be completely ignored
	show_galactic_map_icon = yes
	build_time = 1800
	resources = {
		category = megastructures
		cost = {
			alloys = 40000
			acot_sr_dark_energy = 10000
			sr_dark_matter = 10000
		}
	}
	potential = {
		has_technology = tech_aot_enigmatic_lock_mega
	}
	prerequisites = {
		tech_aot_enigmatic_lock_mega
	}
	possible = {
	}
	upgrade_from = {
		enigmatic_lock_0
	}
	construction_blocks_and_blocked_by = self_type
	on_build_complete = {
		from = {
			country_event = {
				id = aot_enigmatic_lock_events.3
			}
		}
	}
}
